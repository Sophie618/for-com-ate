import { PaddleOcrMcpClient } from "./clients/paddleocr-client";
import { NotionMcpClient } from "./clients/notion-client";
import { createWorkflow } from "./graph";
import { LearnerProfile, LearningTask } from "./types";
import { FeedbackLoopManager } from "./utils/feedback-loop";
import * as readline from 'readline';

/**
 * main å‡½æ•°ä¸²è”æ ·ä¾‹ï¼šè¯»å– demo æ–‡æ¡£ï¼Œæ‰§è¡Œå››ç§ä»»åŠ¡ï¼Œå¹¶è¾“å‡ºç»“æœã€‚
 */
async function main(): Promise<void> {
  console.log("debugging: main started");
  
  // Instantiate real clients
  const ocrClient = new PaddleOcrMcpClient();
  const notionClient = new NotionMcpClient();

  // Get user input
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  const userQuery = await new Promise<string>((resolve) => {
    rl.question('è¯·è¾“å…¥æ‚¨çš„å­¦ä¹ éœ€æ±‚æˆ–é—®é¢˜ (æŒ‰å›è½¦è·³è¿‡): ', (answer) => {
      rl.close();
      resolve(answer);
    });
  });

  if (userQuery) {
    console.log(`debugging: received user query: "${userQuery}"`);
  }
  
  // Search for a parent page to use as the root for new pages
  // Note: Notion API requires a parent page for creating new pages. We cannot create a top-level page directly via API
  // unless we have access to the workspace root, which is not exposed as a simple ID.
  // We will search for a suitable anchor page.
  console.log("debugging: searching for anchor page 'Learning Dashboard'...");
  let parentPageId = "";
  try {
    const dashboardId = await notionClient.searchPage("Learning Dashboard");
    if (dashboardId) {
      parentPageId = dashboardId;
      console.log(`debugging: found anchor page ID (${parentPageId})`);
    } else {
      console.log("debugging: 'Learning Dashboard' not found, searching for any page to use as anchor...");
      const anyPageId = await notionClient.searchPage("");
      if (anyPageId) {
        parentPageId = anyPageId;
        console.log(`debugging: using fallback anchor page ID (${parentPageId})`);
      }
    }
  } catch (error) {
    console.error("debugging: failed to search for parent page", error);
  }

  if (!parentPageId) {
    console.error("Error: Could not find any Notion page to use as a parent. Please ensure you have at least one page in your workspace shared with the integration.");
    process.exit(1);
  }

  // Create a new Session Page under the found anchor page
  const sessionTitle = `Learning Session - ${new Date().toLocaleString()}`;
  console.log(`debugging: creating session page '${sessionTitle}' under anchor page...`);
  
  const sessionPagePayload = {
    parentPageId: parentPageId,
    title: sessionTitle,
    markdownContent: "# Learning Session\n\nGenerated by AI Agent.\n\nThis page contains the results of the current learning session.",
    properties: {
      priority: "High",
      type: "Session",
      dueDate: new Date().toISOString()
    }
  };

  const { id: sessionPageId, url: sessionPageUrl } = await notionClient.createPage(sessionPagePayload);
  console.log(`debugging: created session page ID (${sessionPageId})`);

  // Create LangGraph workflow
  const app = createWorkflow(ocrClient, notionClient);
  const feedbackManager = new FeedbackLoopManager();

  const learnerProfile: LearnerProfile = {
    learnerId: sessionPageId, // Use the new session page as the parent for task pages
    competencyLevel: "ä¸­ç­‰",
    learningGoal: "å·©å›ºä¸€æ¬¡å‡½æ•°ä¸åº”ç”¨é¢˜",
    preferredStyle: "è®²è§£+è®¡åˆ’"
  };

  // Tasks will be generated by the planning node
  const tasks: Array<LearningTask> = [];

  const demoImagePath = `${process.cwd()}/samples/demo1.jpg`;
  
  // Initial State
  const initialState = {
    imagePath: demoImagePath,
    learnerProfile,
    tasks,
    userQuery,
    currentTaskIndex: 0,
    generatedContents: [],
    createdPageIds: []
  };

  console.log("debugging: invoking graph");
  const finalState = await app.invoke(initialState);
  
  const pageIds = finalState.createdPageIds;
  const finalTasks = finalState.tasks as LearningTask[];

  // Feedback loop
  finalTasks.forEach((task, index) => {
    feedbackManager.recordFeedback(task, 4.5 - index * 0.5, `ç¤ºä¾‹åé¦ˆï¼š${task.description}`);
  });
  const strategyNote = feedbackManager.getStrategyNote();
  console.log("debugging: strategy note", strategyNote);
  console.log("debugging: pipeline finished", pageIds);
  
  if (sessionPageUrl) {
    console.log(`\n\nâœ… æµç¨‹ç»“æŸï¼\nğŸ”— çˆ¶é¡µé¢é“¾æ¥ (Session Page): ${sessionPageUrl}\n`);
  } else {
    console.log(`\n\nâœ… æµç¨‹ç»“æŸï¼\nâš ï¸ æœªèƒ½è·å–çˆ¶é¡µé¢é“¾æ¥ï¼Œè¯·æ£€æŸ¥ Notionã€‚Page ID: ${sessionPageId}\n`);
  }
}

// è°ƒç”¨ main å¹¶æ•è·å¼‚å¸¸ã€‚
main().catch((error) => {
  console.error("debugging: pipeline failed", error);
  process.exitCode = 1;
});

