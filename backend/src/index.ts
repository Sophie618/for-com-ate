import { PaddleOcrMcpClient } from "./clients/paddleocr-client";
import { NotionMcpClient } from "./clients/notion-client";
import { createWorkflow } from "./graph";
import { LearnerProfile, LearningTask } from "./types";
import { FeedbackLoopManager } from "./utils/feedback-loop";
import * as readline from 'readline';

/**
 * main å‡½æ•°ä¸²è”æ ·ä¾‹ï¼šè¯»å– demo æ–‡æ¡£ï¼Œæ‰§è¡Œå››ç§ä»»åŠ¡ï¼Œå¹¶è¾“å‡ºç»“æœã€‚
 */
async function main(): Promise<void> {
  console.log("debugging: main started");
  
  // Instantiate real clients
  const ocrClient = new PaddleOcrMcpClient();
  const notionClient = new NotionMcpClient();

  // Get user input
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  const userQuery = await new Promise<string>((resolve) => {
    rl.question('è¯·è¾“å…¥æ‚¨çš„å­¦ä¹ éœ€æ±‚æˆ–é—®é¢˜ (æŒ‰å›è½¦è·³è¿‡): ', (answer) => {
      rl.close();
      resolve(answer);
    });
  });

  if (userQuery) {
    console.log(`debugging: received user query: "${userQuery}"`);
  }
  
  // Search for a parent page to use as the root for new pages
  console.log("debugging: searching for anchor page 'sophie'...");
  let parentPageId = "";
  try {
    const searchResult = await notionClient.searchPage("sophie");
    if (searchResult) {
      console.log(`debugging: found page "${searchResult.title}" (ID: ${searchResult.id})`);
      parentPageId = searchResult.id;
    } else {
      console.error("Error: Could not find a page named 'sophie'.");
      console.error("Please ensure the page exists and is shared with the Notion Integration (click '...' > 'Connect to' > select your integration).");
      process.exit(1);
    }
  } catch (error) {
    console.error("debugging: failed to search for parent page", error);
    process.exit(1);
  }

  if (!parentPageId) {
    console.error("Error: Could not find any Notion page to use as a parent. Please ensure you have at least one page in your workspace shared with the integration.");
    process.exit(1);
  }

  // Use the anchor page directly as the parent for new tasks
  // Removed the intermediate "Learning Session" page creation logic
  const sessionPageId = parentPageId;
  const sessionPageUrl = ""; // We don't have a specific session URL anymore, or we could query it if needed
  console.log(`debugging: using anchor page (${sessionPageId}) as root for this session.`);

  // Create LangGraph workflow
  const app = createWorkflow(ocrClient, notionClient);
  const feedbackManager = new FeedbackLoopManager();

  const learnerProfile: LearnerProfile = {
    learnerId: sessionPageId, // Use the anchor page as the parent for task pages
    competencyLevel: "ä¸­ç­‰",
    learningGoal: "å·©å›ºä¸€æ¬¡å‡½æ•°ä¸åº”ç”¨é¢˜",
    preferredStyle: "è®²è§£+è®¡åˆ’"
  };

  // Tasks will be generated by the planning node
  const tasks: Array<LearningTask> = [];

  const demoImagePath = `${process.cwd()}/samples/demo1.jpg`;
  
  // Initial State
  const initialState = {
    imagePath: demoImagePath,
    learnerProfile,
    tasks,
    userQuery,
    currentTaskIndex: 0,
    generatedContents: [],
    createdPageIds: []
  };

  console.log("debugging: invoking graph");
  const finalState = await app.invoke(initialState);
  
  const finalTasks = finalState.tasks as LearningTask[];
  const pageIds = finalState.createdPageIds as string[];

  // Feedback loop
  finalTasks.forEach((task, index) => {
    feedbackManager.recordFeedback(task, 4.5 - index * 0.5, `ç¤ºä¾‹åé¦ˆï¼š${task.description}`);
  });
  const strategyNote = feedbackManager.getStrategyNote();
  console.log("debugging: strategy note", strategyNote);
  console.log("debugging: pipeline finished");
  
  if (sessionPageUrl) {
    console.log(`\n\nâœ… æµç¨‹ç»“æŸï¼\nğŸ”— ä¼šè¯å®¹å™¨é¡µé¢ (Session Container): ${sessionPageUrl}\n(æ³¨æ„ï¼šè¿™åªæ˜¯ä¼šè¯çš„çˆ¶é¡µé¢ï¼Œå…·ä½“ç”Ÿæˆçš„ç¬”è®°è¯·æŸ¥çœ‹ä¸‹æ–¹çš„å­é¡µé¢é“¾æ¥)`);
  } else {
    console.log(`\n\nâœ… æµç¨‹ç»“æŸï¼\nâš ï¸ æœªèƒ½è·å–ä¼šè¯é¡µé¢é“¾æ¥ï¼Œè¯·æ£€æŸ¥ Notionã€‚Page ID: ${sessionPageId}\n`);
  }

  if (pageIds.length > 0) {
    console.log("ğŸ”— æœ¬æ¬¡è¿è¡Œåˆ›å»ºçš„å…¶ä»–é¡µé¢:");
    pageIds.forEach(id => console.log(`- Page ID: ${id} (è¯·åœ¨ Notion ä¸­æœç´¢æ­¤ ID æˆ–æŸ¥çœ‹ Session Page çš„å­é¡µé¢)`));
  }
  
  console.log("--- æ‰§è¡Œç»“æœæ‘˜è¦ ---");
  (finalState.generatedContents as string[]).forEach((content: string, idx: number) => {
    console.log(`\n[Task ${idx + 1}] Result:\n${content.slice(0, 200)}...`);
  });
}

// è°ƒç”¨ main å¹¶æ•è·å¼‚å¸¸ã€‚
main().catch((error) => {
  console.error("debugging: pipeline failed", error);
  process.exitCode = 1;
});

